{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
    .tab-button { transition: all 0.3s; }
    .tab-button:hover { background-color: #3b82f6; color: white; }
    #video { width: 320px; height: 240px; }
    #canvas { display: none; }
    .hidden { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8 text-pm-blue">Transactions</h1>

    <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
        <!-- Bank Balance Section -->
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Bank Balance</h2>
            <p class="text-xl font-bold">${{ bank_balance }}</p>
        </div>
    </div>

    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <!-- Toggle Buttons for Send Money and Receive Money -->
        <div class="flex border-b">
            <button onclick="changeTab('sendMoneyTab')" class="tab-button px-6 py-3 font-semibold text-gray-700 focus:outline-none">Send Money</button>
            <button onclick="changeTab('receiveMoneyTab')" class="tab-button px-6 py-3 font-semibold text-gray-700 focus:outline-none">Receive Money</button>
        </div>

        <!-- Send Money Section -->
        <div id="sendMoneyTab" class="tab-content p-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Send Money</h2>
            <div class="flex gap-4 mb-6">
                <button id="sendLinkBtn" class="w-full bg-pm-yellow text-white py-2 px-4 rounded-md hover:bg-pm-orange focus:outline-none">Send Using Payment Link</button>
                <button id="sendUpiBtn" class="w-full bg-pm-yellow text-white py-2 px-4 rounded-md hover:bg-pm-orange focus:outline-none">Send Using UPI ID</button>
                <button id="sendQrBtn" class="w-full bg-pm-yellow text-white py-2 px-4 rounded-md hover:bg-pm-orange focus:outline-none">Send Using QR Code</button>
            </div>

            <!-- Payment Link Form -->
            <div id="paymentLinkForm" class="hidden mb-4">
                <form method="POST" action="{{ url_for('transaction') }}">
                    <input type="hidden" name="method" value="payment_link">
                    <div class="mb-4">
                        <label for="paymentLink" class="block text-sm font-medium text-gray-700">Payment Link</label>
                        <input type="text" id="paymentLink" name="recipient" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-pm-yellow focus:border-pm-yellow sm:text-sm">
                    </div>
                    <div class="mb-4">
                        <label for="amountLink" class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" id="amountLink" name="amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-pm-yellow focus:border-pm-yellow sm:text-sm">
                    </div>
                    <button type="submit" class="w-full bg-pm-yellow text-white py-2 px-4 rounded-md hover:bg-pm-orange focus:outline-none">Send Money</button>
                </form>
            </div>

            <!-- UPI ID Form -->
            <div id="upiIdForm" class="hidden mb-4">
                <form method="POST" action="{{ url_for('transaction') }}">
                    <input type="hidden" name="method" value="upi_id">
                    <div class="mb-4">
                        <label for="upiId" class="block text-sm font-medium text-gray-700">UPI ID</label>
                        <input type="text" id="upiId" name="recipient" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-pm-yellow focus:border-pm-yellow sm:text-sm">
                    </div>
                    <div class="mb-4">
                        <label for="amountUpi" class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" id="amountUpi" name="amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-pm-yellow focus:border-pm-yellow sm:text-sm">
                    </div>
                    <button type="submit" class="w-full bg-pm-yellow text-white py-2 px-4 rounded-md hover:bg-pm-orange focus:outline-none">Send Money</button>
                </form>
                <p class="p-4 text-pm-blue">* UPI - Unique Paymate Interface ID</p>
            </div>

            <!-- QR Code Scanner Section -->
            <div id="qrCodeScanner" class="hidden mb-4">
                <button id="scanQrCodeBtn" class="w-full bg-pm-yellow text-white py-2 px-4 rounded-md hover:bg-pm-orange focus:outline-none">Scan QR Code</button>
                <div id="scannerSection" class="hidden">
                    <video id="video" width="320" height="240" autoplay></video>
                    <canvas id="canvas" width="320" height="240"></canvas>
                    <p id="qrCodeStatus" class="text-center mt-4">Scanning QR Code...</p>
                </div>
            </div>

            <!-- QR Code Upload Form -->
            <div id="uploadQrForm" class="hidden mb-4">
                <form method="POST" action="{{ url_for('upload_qr') }}" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="qr_code_image" class="block text-sm font-medium text-gray-700">Upload QR Code Image</label>
                        <input type="file" id="qr_code_image" name="qr_code_image" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-pm-yellow focus:border-pm-yellow sm:text-sm">
                    </div>
                    <button type="submit" class="w-full bg-pm-yellow text-white py-2 px-4 rounded-md hover:bg-pm-orange focus:outline-none">Upload QR Code</button>
                </form>
            </div>

            <!-- QR Code Result Form -->
            <div id="qrCodeResultForm" class="hidden mb-4">
                <form method="POST" action="{{ url_for('transaction') }}">
                    <input type="hidden" name="method" value="qr_code">
                    <input type="hidden" id="scannedRecipient" name="recipient">
                    <div class="mb-4">
                        <label for="amountQrScan" class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" id="amountQrScan" name="amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-pm-yellow focus:border-pm-yellow sm:text-sm">
                    </div>
                    <button type="submit" class="w-full bg-pm-yellow text-white py-2 px-4 rounded-md hover:bg-pm-orange focus:outline-none">Send Money</button>
                </form>
            </div>
        </div>

        <!-- Receive Money Section -->
        <div id="receiveMoneyTab" class="tab-content p-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Receive Money</h2>
            <div class="p-4 bg-white rounded-lg shadow-md">
                <p class="mb-4">Share your QR code and PayMate Transaction ID for receiving payments.</p>
                <div class="mb-4">
                    {% if qr_code %}
                        <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code" id="receiverQrCode" class="w-32 h-32 mx-auto mb-4">
                    {% else %}
                        <p class="text-center text-sm font-medium">No QR Code available</p>
                    {% endif %}
                    <p class="text-center text-sm font-medium">UPI ID: <span id="receiverUpiId">{{ user.upi_id if user.upi_id else 'Not available' }}</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function changeTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.getElementById(tabId).classList.remove('hidden');
}

document.getElementById('sendLinkBtn').addEventListener('click', function() {
    document.getElementById('paymentLinkForm').classList.remove('hidden');
    document.getElementById('upiIdForm').classList.add('hidden');
    document.getElementById('qrCodeScanner').classList.add('hidden');
    document.getElementById('uploadQrForm').classList.add('hidden');
    document.getElementById('qrCodeResultForm').classList.add('hidden');
});

document.getElementById('sendUpiBtn').addEventListener('click', function() {
    document.getElementById('upiIdForm').classList.remove('hidden');
    document.getElementById('paymentLinkForm').classList.add('hidden');
    document.getElementById('qrCodeScanner').classList.add('hidden');
    document.getElementById('uploadQrForm').classList.add('hidden');
    document.getElementById('qrCodeResultForm').classList.add('hidden');
});

document.getElementById('sendQrBtn').addEventListener('click', function() {
    document.getElementById('qrCodeScanner').classList.remove('hidden');
    document.getElementById('uploadQrForm').classList.remove('hidden');
    document.getElementById('paymentLinkForm').classList.add('hidden');
    document.getElementById('upiIdForm').classList.add('hidden');
    document.getElementById('qrCodeResultForm').classList.add('hidden');
});

document.getElementById('scanQrCodeBtn').addEventListener('click', function() {
    document.getElementById('scannerSection').classList.remove('hidden');
    startCamera();
});

function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
            const video = document.getElementById('video');
            video.srcObject = stream;
            video.play();
            detectQrCode();
        })
        .catch(err => {
            console.error('Error accessing camera:', err);
        });
}

function detectQrCode() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    if (video.paused || video.ended) return;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    // Convert to grayscale
    const grayImageData = convertToGrayscale(imageData);

    // Use OpenCV to process grayscale image
    const srcMat = cv.matFromImageData(grayImageData);
    const grayMat = new cv.Mat();
    const qrCodeDetector = new cv.QRCodeDetector();

    // Convert the grayscale image to the correct format
    cv.cvtColor(srcMat, grayMat, cv.COLOR_RGBA2GRAY);

    const [status, points, qrCode] = qrCodeDetector.detectAndDecode(grayMat);

    if (status) {
        document.getElementById('scannedRecipient').value = qrCode;
        document.getElementById('qrCodeScanner').classList.add('hidden');
        document.getElementById('qrCodeResultForm').classList.remove('hidden');
        const stream = video.srcObject;
        if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
        }
    }

    srcMat.delete();
    grayMat.delete();

    requestAnimationFrame(detectQrCode);
}

function convertToGrayscale(imageData) {
    const grayData = new Uint8ClampedArray(imageData.width * imageData.height);
    const data = imageData.data;

    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
        grayData[i / 4] = gray;
    }

    return new ImageData(grayData, imageData.width, imageData.height);
}
</script>
{% endblock %}
